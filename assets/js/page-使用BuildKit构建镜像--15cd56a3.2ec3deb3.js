(window.webpackJsonp=window.webpackJsonp||[]).push([[92],{463:function(s,t,a){"use strict";a.r(t);var n=a(3),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"使用-buildkit-构建镜像"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用-buildkit-构建镜像"}},[s._v("#")]),s._v(" 使用 "),a("code",[s._v("BuildKit")]),s._v(" 构建镜像")]),s._v(" "),a("AdSenseTitle"),s._v(" "),a("p",[a("strong",[s._v("BuildKit")]),s._v(" 是下一代的镜像构建组件，在 https://github.com/moby/buildkit 开源。")]),s._v(" "),a("p",[a("strong",[s._v("注意：如果您的镜像构建使用的是云服务商提供的镜像构建服务（腾讯云容器服务、阿里云容器服务等），由于上述服务提供商的 Docker 版本低于 18.09，BuildKit 无法使用，将造成镜像构建失败。建议使用 BuildKit 构建镜像时使用一个新的 Dockerfile 文件（例如 Dockerfile.buildkit）")])]),s._v(" "),a("p",[s._v("目前，Docker Hub 自动构建已经支持 buildkit，具体请参考 https://github.com/docker-practice/docker-hub-buildx")]),s._v(" "),a("h2",{attrs:{id:"dockerfile-新增指令详解"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#dockerfile-新增指令详解"}},[s._v("#")]),s._v(" "),a("code",[s._v("Dockerfile")]),s._v(" 新增指令详解")]),s._v(" "),a("p",[s._v("启用 "),a("code",[s._v("BuildKit")]),s._v(" 之后，我们可以使用下面几个新的 "),a("code",[s._v("Dockerfile")]),s._v(" 指令来加快镜像构建。")]),s._v(" "),a("h3",{attrs:{id:"run-mount-type-cache"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#run-mount-type-cache"}},[s._v("#")]),s._v(" "),a("code",[s._v("RUN --mount=type=cache")])]),s._v(" "),a("p",[s._v("目前，几乎所有的程序都会使用依赖管理工具，例如 "),a("code",[s._v("Go")]),s._v(" 中的 "),a("code",[s._v("go mod")]),s._v("、"),a("code",[s._v("Node.js")]),s._v(" 中的 "),a("code",[s._v("npm")]),s._v(" 等等，当我们构建一个镜像时，往往会重复的从互联网中获取依赖包，难以缓存，大大降低了镜像的构建效率。")]),s._v(" "),a("p",[s._v("例如一个前端工程需要用到 "),a("code",[s._v("npm")]),s._v("：")]),s._v(" "),a("div",{staticClass:"language-docker line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-docker"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" node"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("alpine as builder\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /app\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" package.json /app/\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm i "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("registry=https"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//registry.npm.taobao.org \\\n        && rm "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("rf ~/.npm\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" src /app/src\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm run build\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("alpine\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("from=builder /app/dist /app/dist\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("p",[s._v("使用多阶段构建，构建的镜像中只包含了目标文件夹 "),a("code",[s._v("dist")]),s._v("，但仍然存在一些问题，当 "),a("code",[s._v("package.json")]),s._v(" 文件变动时，"),a("code",[s._v("RUN npm i && rm -rf ~/.npm")]),s._v(" 这一层会重新执行，变更多次后，生成了大量的中间层镜像。")]),s._v(" "),a("p",[s._v("为解决这个问题，进一步的我们可以设想一个类似 "),a("strong",[s._v("数据卷")]),s._v(" 的功能，在镜像构建时把 "),a("code",[s._v("node_modules")]),s._v(" 文件夹挂载上去，在构建完成后，这个 "),a("code",[s._v("node_modules")]),s._v(" 文件夹会自动卸载，实际的镜像中并不包含 "),a("code",[s._v("node_modules")]),s._v(" 这个文件夹，这样我们就省去了每次获取依赖的时间，大大增加了镜像构建效率，同时也避免了生成了大量的中间层镜像。")]),s._v(" "),a("p",[a("code",[s._v("BuildKit")]),s._v(" 提供了 "),a("code",[s._v("RUN --mount=type=cache")]),s._v(" 指令，可以实现上边的设想。")]),s._v(" "),a("div",{staticClass:"language-docker line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-docker"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# syntax = docker/dockerfile:experimental")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" node"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("alpine as builder\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /app\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" package.json /app/\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("mount=type=cache"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("target=/app/node_modules"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("id=my_app_npm_module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("sharing=locked \\\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("mount=type=cache"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("target=/root/.npm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("id=npm_cache \\\n        npm i "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("registry=https"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//registry.npm.taobao.org\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" src /app/src\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("mount=type=cache"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("target=/app/node_modules"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("id=my_app_npm_module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("sharing=locked \\\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# --mount=type=cache,target=/app/dist,id=my_app_dist,sharing=locked \\")]),s._v("\n        npm run build\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("alpine\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# COPY --from=builder /app/dist /app/dist")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 为了更直观的说明 from 和 source 指令，这里使用 RUN 指令")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("mount=type=cache"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("target=/tmp/dist"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("from=builder"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("source=/app/dist \\\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# --mount=type=cache,target/tmp/dist,from=my_app_dist,sharing=locked \\")]),s._v("\n    mkdir "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("p /app/dist && cp "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("r /tmp/dist/* /app/dist\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br")])]),a("p",[a("strong",[s._v("由于 "),a("code",[s._v("BuildKit")]),s._v(" 为实验特性，每个 "),a("code",[s._v("Dockerfile")]),s._v(" 文件开头都必须加上如下指令")])]),s._v(" "),a("div",{staticClass:"language-docker line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-docker"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# syntax = docker/dockerfile:experimental")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("第一个 "),a("code",[s._v("RUN")]),s._v(" 指令执行后，"),a("code",[s._v("id")]),s._v(" 为 "),a("code",[s._v("my_app_npm_module")]),s._v(" 的缓存文件夹挂载到了 "),a("code",[s._v("/app/node_modules")]),s._v(" 文件夹中。多次执行也不会产生多个中间层镜像。")]),s._v(" "),a("p",[s._v("第二个 "),a("code",[s._v("RUN")]),s._v(" 指令执行时需要用到 "),a("code",[s._v("node_modules")]),s._v(" 文件夹，"),a("code",[s._v("node_modules")]),s._v(" 已经挂载，命令也可以正确执行。")]),s._v(" "),a("p",[s._v("第三个 "),a("code",[s._v("RUN")]),s._v(" 指令将上一阶段产生的文件复制到指定位置，"),a("code",[s._v("from")]),s._v(" 指明缓存的来源，这里 "),a("code",[s._v("builder")]),s._v(" 表示缓存来源于构建的第一阶段，"),a("code",[s._v("source")]),s._v(" 指明缓存来源的文件夹。")]),s._v(" "),a("p",[s._v("上面的 "),a("code",[s._v("Dockerfile")]),s._v(" 中 "),a("code",[s._v("--mount=type=cache,...")]),s._v(" 中指令作用如下：")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("Option")]),s._v(" "),a("th",[s._v("Description")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[a("code",[s._v("id")])]),s._v(" "),a("td",[a("code",[s._v("id")]),s._v(" 设置一个标志，以便区分缓存。")])]),s._v(" "),a("tr",[a("td",[a("code",[s._v("target")]),s._v(" (必填项)")]),s._v(" "),a("td",[s._v("缓存的挂载目标文件夹。")])]),s._v(" "),a("tr",[a("td",[a("code",[s._v("ro")]),s._v(","),a("code",[s._v("readonly")])]),s._v(" "),a("td",[s._v("只读，缓存文件夹不能被写入。")])]),s._v(" "),a("tr",[a("td",[a("code",[s._v("sharing")])]),s._v(" "),a("td",[s._v("有 "),a("code",[s._v("shared")]),s._v(" "),a("code",[s._v("private")]),s._v(" "),a("code",[s._v("locked")]),s._v(" 值可供选择。"),a("code",[s._v("sharing")]),s._v(" 设置当一个缓存被多次使用时的表现，由于 "),a("code",[s._v("BuildKit")]),s._v(" 支持并行构建，当多个步骤使用同一缓存时（同一 "),a("code",[s._v("id")]),s._v("）会发生冲突。"),a("code",[s._v("shared")]),s._v(" 表示多个步骤可以同时读写，"),a("code",[s._v("private")]),s._v(" 表示当多个步骤使用同一缓存时，每个步骤使用不同的缓存，"),a("code",[s._v("locked")]),s._v(" 表示当一个步骤完成释放缓存后，后一个步骤才能继续使用该缓存。")])]),s._v(" "),a("tr",[a("td",[a("code",[s._v("from")])]),s._v(" "),a("td",[s._v("缓存来源（构建阶段），不填写时为空文件夹。")])]),s._v(" "),a("tr",[a("td",[a("code",[s._v("source")])]),s._v(" "),a("td",[s._v("来源的文件夹路径。")])])])]),s._v(" "),a("h3",{attrs:{id:"run-mount-type-bind"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#run-mount-type-bind"}},[s._v("#")]),s._v(" "),a("code",[s._v("RUN --mount=type=bind")])]),s._v(" "),a("p",[s._v("该指令可以将一个镜像（或上一构建阶段）的文件挂载到指定位置。")]),s._v(" "),a("div",{staticClass:"language-docker line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-docker"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# syntax = docker/dockerfile:experimental")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("mount=type=bind"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("from=php"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("alpine"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("source=/usr/local/bin/docker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("php"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("entrypoint"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("target=/docker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("php"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("entrypoint \\\n        cat /docker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("php"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("entrypoint\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h3",{attrs:{id:"run-mount-type-tmpfs"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#run-mount-type-tmpfs"}},[s._v("#")]),s._v(" "),a("code",[s._v("RUN --mount=type=tmpfs")])]),s._v(" "),a("p",[s._v("该指令可以将一个 "),a("code",[s._v("tmpfs")]),s._v(" 文件系统挂载到指定位置。")]),s._v(" "),a("div",{staticClass:"language-docker line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-docker"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# syntax = docker/dockerfile:experimental")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("mount=type=tmpfs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("target=/temp \\\n        mount "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" grep /temp\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h3",{attrs:{id:"run-mount-type-secret"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#run-mount-type-secret"}},[s._v("#")]),s._v(" "),a("code",[s._v("RUN --mount=type=secret")])]),s._v(" "),a("p",[s._v("该指令可以将一个文件(例如密钥)挂载到指定位置。")]),s._v(" "),a("div",{staticClass:"language-docker line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-docker"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# syntax = docker/dockerfile:experimental")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("mount=type=secret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("id=aws"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("target=/root/.aws/credentials \\\n        cat /root/.aws/credentials\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ docker build -t "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v(" --secret "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("id")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("aws,src"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$HOME")]),s._v("/.aws/credentials "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"run-mount-type-ssh"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#run-mount-type-ssh"}},[s._v("#")]),s._v(" "),a("code",[s._v("RUN --mount=type=ssh")])]),s._v(" "),a("p",[s._v("该指令可以挂载 "),a("code",[s._v("ssh")]),s._v(" 密钥。")]),s._v(" "),a("div",{staticClass:"language-docker line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-docker"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# syntax = docker/dockerfile:experimental")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" alpine\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" apk add "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("no"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("cache openssh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("client\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" mkdir "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("p "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("m 0700 ~/.ssh && ssh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("keyscan gitlab.com "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(" ~/.ssh/known_hosts\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("mount=type=ssh ssh git@gitlab.com "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" tee /hello\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("eval")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("ssh-agent"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n$ ssh-add ~/.ssh/id_rsa\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Input your passphrase here"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n$ docker build -t "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v(" --ssh "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("default")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$SSH_AUTH_SOCK")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h2",{attrs:{id:"docker-compose-build-使用-buildkit"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#docker-compose-build-使用-buildkit"}},[s._v("#")]),s._v(" docker-compose build 使用 Buildkit")]),s._v(" "),a("p",[s._v("设置 "),a("code",[s._v("COMPOSE_DOCKER_CLI_BUILD=1")]),s._v(" 环境变量即可使用。")]),s._v(" "),a("h2",{attrs:{id:"官方文档"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#官方文档"}},[s._v("#")]),s._v(" 官方文档")]),s._v(" "),a("ul",[a("li",[s._v("https://github.com/moby/buildkit/blob/master/frontend/dockerfile/docs/experimental.md")])])],1)}),[],!1,null,null,null);t.default=e.exports}}]);