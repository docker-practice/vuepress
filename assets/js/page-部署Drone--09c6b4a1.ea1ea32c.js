(window.webpackJsonp=window.webpackJsonp||[]).push([[187],{491:function(t,s,a){"use strict";a.r(s);var n=a(3),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"部署-drone"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署-drone"}},[t._v("#")]),t._v(" 部署 Drone")]),t._v(" "),a("h2",{attrs:{id:"要求"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#要求"}},[t._v("#")]),t._v(" 要求")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("拥有公网 IP、域名 (如果你不满足要求，可以尝试在本地使用 Gogs + Drone)")])]),t._v(" "),a("li",[a("p",[t._v("域名 SSL 证书 (目前国内有很多云服务商提供免费证书)")])]),t._v(" "),a("li",[a("p",[t._v("熟悉 "),a("code",[t._v("Docker")]),t._v(" 以及 "),a("code",[t._v("Docker Compose")])])]),t._v(" "),a("li",[a("p",[t._v("熟悉 "),a("code",[t._v("Git")]),t._v(" 基本命令")])]),t._v(" "),a("li",[a("p",[t._v("对 "),a("code",[t._v("CI/CD")]),t._v(" 有一定了解")])])]),t._v(" "),a("h2",{attrs:{id:"新建-github-应用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#新建-github-应用"}},[t._v("#")]),t._v(" 新建 GitHub 应用")]),t._v(" "),a("p",[t._v("登录 GitHub，在 https://github.com/settings/applications/new 新建一个应用。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://docs.drone.io/screenshots/github_application_create.png",alt:""}})]),t._v(" "),a("p",[t._v("接下来查看这个应用的详情，记录 "),a("code",[t._v("Client ID")]),t._v(" 和 "),a("code",[t._v("Client Secret")]),t._v("，之后配置 Drone 会用到。")]),t._v(" "),a("h2",{attrs:{id:"配置-drone"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置-drone"}},[t._v("#")]),t._v(" 配置 Drone")]),t._v(" "),a("p",[t._v("我们通过使用 "),a("code",[t._v("Docker Compose")]),t._v(" 来启动 "),a("code",[t._v("Drone")]),t._v("，编写 "),a("code",[t._v("docker-compose.yml")]),t._v(" 文件。")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'3'")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("services")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("drone-server")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" drone/drone"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" 443"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token datetime number"}},[t._v("80:80")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" drone"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("rw\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ./ssl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/etc/certs\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restart")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" always\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DRONE_AGENTS_ENABLED=true\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DRONE_SERVER_HOST=$"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("DRONE_SERVER_HOST"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("https"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//drone.yeasy.com"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DRONE_SERVER_PROTO=$"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("DRONE_SERVER_PROTO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("https"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DRONE_RPC_SECRET=$"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("DRONE_RPC_SECRET"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("secret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DRONE_GITHUB_SERVER=https"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//github.com\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DRONE_GITHUB_CLIENT_ID=$"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("DRONE_GITHUB_CLIENT_ID"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DRONE_GITHUB_CLIENT_SECRET=$"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("DRONE_GITHUB_CLIENT_SECRET"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("drone-agent")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" drone/drone"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("runner"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("docker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restart")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" always\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("depends_on")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" drone"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("server\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /var/run/docker.sock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/var/run/docker.sock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("rw\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DRONE_RPC_PROTO=http\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DRONE_RPC_HOST=drone"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("server\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DRONE_RPC_SECRET=$"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("DRONE_RPC_SECRET"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("secret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DRONE_RUNNER_NAME=$"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("HOSTNAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("demo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DRONE_RUNNER_CAPACITY=2\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("dns")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 114.114.114.114\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("drone-data")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n")])])]),a("p",[t._v("新建 "),a("code",[t._v(".env")]),t._v(" 文件，输入变量及其值")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 必填 服务器地址，例如 drone.domain.com")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("DRONE_SERVER_HOST")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("DRONE_SERVER_PROTO")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("https\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("DRONE_RPC_SECRET")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("secret\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("HOSTNAME")])]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("demo\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 必填 在 GitHub 应用页面查看")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("DRONE_GITHUB_CLIENT_ID")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 必填 在 GitHub 应用页面查看")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("DRONE_GITHUB_CLIENT_SECRET")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n")])])]),a("h3",{attrs:{id:"启动-drone"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#启动-drone"}},[t._v("#")]),t._v(" 启动 Drone")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ docker-compose up -d\n")])])])])}),[],!1,null,null,null);s.default=e.exports}}]);