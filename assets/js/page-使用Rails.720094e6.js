(window.webpackJsonp=window.webpackJsonp||[]).push([[93],{523:function(s,a,e){"use strict";e.r(a);var t=e(1),n=Object(t.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"使用-rails"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#使用-rails"}},[s._v("#")]),s._v(" 使用 Rails")]),s._v(" "),e("AdSenseTitle"),s._v(" "),e("blockquote",[e("p",[s._v("本小节内容适合 "),e("code",[s._v("Ruby")]),s._v(" 开发人员阅读。")])]),s._v(" "),e("p",[s._v("我们现在将使用 "),e("code",[s._v("Compose")]),s._v(" 配置并运行一个 "),e("code",[s._v("Rails/PostgreSQL")]),s._v(" 应用。")]),s._v(" "),e("p",[s._v("在一切工作开始前，需要先设置好三个必要的文件。")]),s._v(" "),e("p",[s._v("首先，因为应用将要运行在一个满足所有环境依赖的 Docker 容器里面，那么我们可以通过编辑 "),e("code",[s._v("Dockerfile")]),s._v(" 文件来指定 Docker 容器要安装内容。内容如下：")]),s._v(" "),e("div",{staticClass:"language-docker line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-docker"}},[e("code",[e("span",{pre:!0,attrs:{class:"token instruction"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" ruby")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token instruction"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" apt-get update -qq && apt-get install -y build-essential libpq-dev")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token instruction"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" mkdir /myapp")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token instruction"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /myapp")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token instruction"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ADD")]),s._v(" Gemfile /myapp/Gemfile")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token instruction"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" bundle install")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token instruction"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ADD")]),s._v(" . /myapp")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("以上内容指定应用将使用安装了 Ruby、Bundler 以及其依赖件的镜像。更多关于如何编写 Dockerfile 文件的信息可以查看 "),e("RouterLink",{attrs:{to:"/image/dockerfile/"}},[s._v("Dockerfile 使用")]),s._v("。")],1),s._v(" "),e("p",[s._v("下一步，我们需要一个引导加载 Rails 的文件 "),e("code",[s._v("Gemfile")]),s._v(" 。 等一会儿它还会被 "),e("code",[s._v("rails new")]),s._v(" 命令覆盖重写。")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'https://rubygems.org'")]),s._v("\ngem "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'rails'")]),s._v(", "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'4.0.2'")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("最后，"),e("code",[s._v("docker-compose.yml")]),s._v(" 文件才是最神奇的地方。 "),e("code",[s._v("docker-compose.yml")]),s._v(" 文件将把所有的东西关联起来。它描述了应用的构成（一个 web 服务和一个数据库）、每个镜像的来源（数据库运行在使用预定义的 PostgreSQL 镜像，web 应用侧将从本地目录创建）、镜像之间的连接，以及服务开放的端口。")]),s._v(" "),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("version")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"3"')]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("services")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("db")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" postgres\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5432"')]),s._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("web")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("build")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" .\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" bundle exec rackup "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("p 3000\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ."),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/myapp\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"3000:3000"')]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br")])]),e("p",[s._v("所有文件就绪后，我们就可以通过使用 "),e("code",[s._v("docker-compose run")]),s._v(" 命令生成应用的骨架了。")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("$ docker-compose run web rails new "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v(" --force --database"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("postgresql --skip-bundle\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("code",[s._v("Compose")]),s._v(" 会先使用 "),e("code",[s._v("Dockerfile")]),s._v(" 为 web 服务创建一个镜像，接着使用这个镜像在容器里运行 "),e("code",[s._v("rails new")]),s._v(" 和它之后的命令。一旦这个命令运行完后，应该就可以看一个崭新的应用已经生成了。")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\nDockerfile   app          docker-compose.yml      tmp\nGemfile      bin          lib          vendor\nGemfile.lock condocker-compose       log\nREADME.rdoc  condocker-compose.ru    public\nRakefile     db           "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("在新的 "),e("code",[s._v("Gemfile")]),s._v(" 文件去掉加载 "),e("code",[s._v("therubyracer")]),s._v(" 的行的注释，这样我们便可以使用 Javascript 运行环境：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("gem "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'therubyracer'")]),s._v(", platforms: :ruby\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("现在我们已经有一个新的 "),e("code",[s._v("Gemfile")]),s._v(" 文件，需要再重新创建镜像。（这个会步骤会改变 Dockerfile 文件本身，所以需要重建一次）。")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("$ docker-compose build\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("应用现在就可以启动了，但配置还未完成。Rails 默认读取的数据库目标是 "),e("code",[s._v("localhost")]),s._v(" ，我们需要手动指定容器的 "),e("code",[s._v("db")]),s._v(" 。同样的，还需要把用户名修改成和 postgres 镜像预定的一致。\n打开最新生成的 "),e("code",[s._v("database.yml")]),s._v(" 文件。用以下内容替换：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("development: "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("default\n  adapter: postgresql\n  encoding: unicode\n  database: postgres\n  pool: "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\n  username: postgres\n  password:\n  host: db\n\ntest:\n  "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(": *default\n  database: myapp_test\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br")])]),e("p",[s._v("现在就可以启动应用了。")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("$ docker-compose up\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("如果一切正常，你应该可以看到 PostgreSQL 的输出，几秒后可以看到这样的重复信息：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("myapp_web_1 "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2014")]),s._v("-01-17 "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":16:29"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" INFO  WEBrick "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.3")]),s._v(".1\nmyapp_web_1 "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2014")]),s._v("-01-17 "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":16:29"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" INFO  ruby "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.0")]),s._v(".0 "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2013")]),s._v("-11-22"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("x86_64-linux-gnu"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nmyapp_web_1 "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2014")]),s._v("-01-17 "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":16:29"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" INFO  WEBrick::HTTPServer"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#start: pid=1 port=3000")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("最后， 我们需要做的是创建数据库，打开另一个终端，运行：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("$ docker-compose run web rake db:create\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("这个 web 应用已经开始在你的 docker 守护进程里面监听着 3000 端口了。")])],1)}),[],!1,null,null,null);a.default=n.exports}}]);