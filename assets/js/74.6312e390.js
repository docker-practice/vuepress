(window.webpackJsonp=window.webpackJsonp||[]).push([[74],{421:function(s,a,t){"use strict";t.r(a);var e=t(43),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"使用-rails"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用-rails"}},[s._v("#")]),s._v(" 使用 Rails")]),s._v(" "),t("blockquote",[t("p",[s._v("本小节内容适合 "),t("code",[s._v("Ruby")]),s._v(" 开发人员阅读。")])]),s._v(" "),t("p",[s._v("我们现在将使用 "),t("code",[s._v("Compose")]),s._v(" 配置并运行一个 "),t("code",[s._v("Rails/PostgreSQL")]),s._v(" 应用。")]),s._v(" "),t("p",[s._v("在一切工作开始前，需要先设置好三个必要的文件。")]),s._v(" "),t("p",[s._v("首先，因为应用将要运行在一个满足所有环境依赖的 Docker 容器里面，那么我们可以通过编辑 "),t("code",[s._v("Dockerfile")]),s._v(" 文件来指定 Docker 容器要安装内容。内容如下：")]),s._v(" "),t("div",{staticClass:"language-docker extra-class"},[t("pre",{pre:!0,attrs:{class:"language-docker"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" ruby\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" apt"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("get update "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("qq && apt"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("get install "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("y build"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("essential libpq"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("dev\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" mkdir /myapp\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /myapp\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ADD")]),s._v(" Gemfile /myapp/Gemfile\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" bundle install\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ADD")]),s._v(" . /myapp\n")])])]),t("p",[s._v("以上内容指定应用将使用安装了 Ruby、Bundler 以及其依赖件的镜像。更多关于如何编写 Dockerfile 文件的信息可以查看 "),t("RouterLink",{attrs:{to:"/image/dockerfile/"}},[s._v("Dockerfile 使用")]),s._v("。")],1),s._v(" "),t("p",[s._v("下一步，我们需要一个引导加载 Rails 的文件 "),t("code",[s._v("Gemfile")]),s._v(" 。 等一会儿它还会被 "),t("code",[s._v("rails new")]),s._v(" 命令覆盖重写。")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'https://rubygems.org'")]),s._v("\ngem "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'rails'")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'4.0.2'")]),s._v("\n")])])]),t("p",[s._v("最后，"),t("code",[s._v("docker-compose.yml")]),s._v(" 文件才是最神奇的地方。 "),t("code",[s._v("docker-compose.yml")]),s._v(" 文件将把所有的东西关联起来。它描述了应用的构成（一个 web 服务和一个数据库）、每个镜像的来源（数据库运行在使用预定义的 PostgreSQL 镜像，web 应用侧将从本地目录创建）、镜像之间的连接，以及服务开放的端口。")]),s._v(" "),t("div",{staticClass:"language-yaml extra-class"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("version")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"3"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("services")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("db")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" postgres\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5432"')]),s._v("\n\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("web")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("build")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" .\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" bundle exec rackup "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("p 3000\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ."),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/myapp\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"3000:3000"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("links")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" db\n")])])]),t("p",[s._v("所有文件就绪后，我们就可以通过使用 "),t("code",[s._v("docker-compose run")]),s._v(" 命令生成应用的骨架了。")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("$ docker-compose run web rails new "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v(" --force --database"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("postgresql --skip-bundle\n")])])]),t("p",[t("code",[s._v("Compose")]),s._v(" 会先使用 "),t("code",[s._v("Dockerfile")]),s._v(" 为 web 服务创建一个镜像，接着使用这个镜像在容器里运行 "),t("code",[s._v("rails new")]),s._v(" 和它之后的命令。一旦这个命令运行完后，应该就可以看一个崭新的应用已经生成了。")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\nDockerfile   app          docker-compose.yml      tmp\nGemfile      bin          lib          vendor\nGemfile.lock condocker-compose       log\nREADME.rdoc  condocker-compose.ru    public\nRakefile     db           "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\n")])])]),t("p",[s._v("在新的 "),t("code",[s._v("Gemfile")]),s._v(" 文件去掉加载 "),t("code",[s._v("therubyracer")]),s._v(" 的行的注释，这样我们便可以使用 Javascript 运行环境：")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("gem "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'therubyracer'")]),s._v(", platforms: :ruby\n")])])]),t("p",[s._v("现在我们已经有一个新的 "),t("code",[s._v("Gemfile")]),s._v(" 文件，需要再重新创建镜像。（这个会步骤会改变 Dockerfile 文件本身，所以需要重建一次）。")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("$ docker-compose build\n")])])]),t("p",[s._v("应用现在就可以启动了，但配置还未完成。Rails 默认读取的数据库目标是 "),t("code",[s._v("localhost")]),s._v(" ，我们需要手动指定容器的 "),t("code",[s._v("db")]),s._v(" 。同样的，还需要把用户名修改成和 postgres 镜像预定的一致。\n打开最新生成的 "),t("code",[s._v("database.yml")]),s._v(" 文件。用以下内容替换：")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("development: "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("default\n  adapter: postgresql\n  encoding: unicode\n  database: postgres\n  pool: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\n  username: postgres\n  password:\n  host: db\n\ntest:\n  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(": *default\n  database: myapp_test\n")])])]),t("p",[s._v("现在就可以启动应用了。")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("$ docker-compose up\n")])])]),t("p",[s._v("如果一切正常，你应该可以看到 PostgreSQL 的输出，几秒后可以看到这样的重复信息：")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("myapp_web_1 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2014")]),s._v("-01-17 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":16:29"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" INFO  WEBrick "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.3")]),s._v(".1\nmyapp_web_1 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2014")]),s._v("-01-17 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":16:29"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" INFO  ruby "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.0")]),s._v(".0 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2013")]),s._v("-11-22"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("x86_64-linux-gnu"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nmyapp_web_1 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2014")]),s._v("-01-17 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":16:29"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" INFO  WEBrick::HTTPServer"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#start: pid=1 port=3000")]),s._v("\n")])])]),t("p",[s._v("最后， 我们需要做的是创建数据库，打开另一个终端，运行：")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("$ docker-compose run web rake db:create\n")])])]),t("p",[s._v("这个 web 应用已经开始在你的 docker 守护进程里面监听着 3000 端口了。")])])}),[],!1,null,null,null);a.default=n.exports}}]);